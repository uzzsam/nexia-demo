<!DOCTYPE html>
<html lang="en-GB">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>OEM BDM â€“ Overview Dashboard (Mockup)</title>
<style>
  /* ---------- Design tokens ---------- */
  :root{
    --bg-0:#0f1420;
    --bg-1:#101727;
    --bg-2:#131c31;
    --card:#ffffff;
    --ink:#0d1b2a;
    --muted:#5b6575;
    --muted-2:#80889a;
    --border:#e6e8ef;
    --accent:#ff725e;         /* coral accent for primary KPIs */
    --accent-2:#4f8cff;       /* action */
    --good:#14b866;
    --warn:#f5a524;
    --bad:#ef4e4e;
    --shadow: 0 8px 24px rgba(7, 16, 35, .12);
    --radius:14px;
    --radius-sm:10px;
    --radius-lg:22px;
    --grid-gap:16px;
    --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
  }
  @media (prefers-color-scheme: dark) {
    :root{
      --card:#111827;
      --ink:#eef2fb;
      --muted:#a0a9bd;
      --muted-2:#94a0b8;
      --border:#1f2a44;
      --shadow: 0 6px 18px rgba(0,0,0,.35);
    }
  }

  /* ---------- Base ---------- */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:var(--font);
    background:linear-gradient(180deg,#f6f7fb 0%,#f1f4fa 100%);
    color:var(--ink);
  }
  @media (prefers-color-scheme: dark){
    body{background:linear-gradient(180deg,#0a1020 0%,#0e1528 100%)}
  }

  a{color:var(--accent-2);text-decoration:none}
  small, .muted{color:var(--muted)}

  .container{
    display:grid;
    grid-template-columns: 80px 1fr;
    min-height:100vh;
  }

  /* ---------- Sidebar ---------- */
  .sidebar{
    background:#0d1324;
    color:#dbe1f1;
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:16px 10px;
    gap:14px;
  }
  .brand{
    width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#ff9d7f);
    display:grid;place-items:center;color:white;font-weight:800;letter-spacing:.5px; box-shadow:0 10px 20px rgba(255,114,94,.35)
  }
  .nav-btn{
    width:48px;height:48px;border-radius:12px;border:1px solid #1a2342;background:#0f1631;
    display:grid;place-items:center;cursor:pointer;transition:.2s;
  }
  .nav-btn svg{opacity:.9}
  .nav-btn.active,.nav-btn:hover{border-color:#2a3866;background:#111a3d}
  .spacer{flex:1}
  .avatar{width:36px;height:36px;border-radius:50%;background:#1a2342;display:grid;place-items:center;font-size:12px}

  /* ---------- Header / filters ---------- */
  header{
    position:sticky; top:0; z-index:10;
    background:rgba(255,255,255,.85);
    backdrop-filter: saturate(120%) blur(10px);
    border-bottom:1px solid var(--border);
  }
  @media (prefers-color-scheme: dark){
    header{background:rgba(13,19,36,.7)}
  }
  .topbar{
    display:flex;align-items:center;gap:12px;padding:14px 18px;
  }
  .search{
    flex:1;display:flex;align-items:center;gap:10px;
    background:var(--card); border:1px solid var(--border); border-radius:14px; padding:10px 12px;
    box-shadow: var(--shadow);
  }
  .search input{
    border:0;outline:0;background:transparent;width:100%;color:var(--ink);font-size:14px
  }
  .chip{
    display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--card);
    padding:8px 12px;border-radius:999px;font-size:12px;box-shadow: var(--shadow);
  }
  .fresh{
    display:flex;align-items:center;gap:6px;font-size:12px;
    padding:8px 10px;border-radius:999px;background:#eafaf1;color:#105f3b;border:1px solid #b9ebcf;
  }
  @media (prefers-color-scheme: dark){ .fresh{background:#0f2a1f;border-color:#194d37;color:#9ae6b4} }

  /* ---------- Layout grid ---------- */
  main{
    padding:18px;
    display:grid;
    gap:18px;
    grid-template-columns: 1.25fr 1fr;
  }
  .full{grid-column:1/-1}

  /* ---------- KPI strip ---------- */
  .kpi-strip{
    display:grid; grid-auto-flow:column; grid-auto-columns: 320px;
    gap:16px; overflow-x:auto; padding-bottom:2px; scrollbar-width:thin;
  }
  .kpi{
    background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow);
    display:grid; gap:10px; position:relative;
  }
  .kpi .title{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .kpi .title h4{margin:0;font-size:14px;font-weight:700}
  .badge{
    font-size:11px; padding:4px 8px;border-radius:999px;border:1px solid var(--border); background:#fafafb;
  }
  @media (prefers-color-scheme: dark){ .badge{background:#111827;border-color:#222f4f} }
  .value{
    display:flex;align-items:baseline;gap:10px
  }
  .value strong{font-size:30px;letter-spacing:-.2px}
  .delta{font-size:12px;border-radius:8px;padding:3px 6px}
  .delta.up{background:#eafaf1;color:#0b6a42;border:1px solid #b7e7cd}
  .delta.down{background:#fff1f1;color:#a32424;border:1px solid #f3c8c8}
  .spark{height:44px}
  .bar{
    height:8px;border-radius:6px;background:#eef2fb;overflow:hidden;position:relative;border:1px solid var(--border)
  }
  .bar > i{
    display:block;height:100%;background:linear-gradient(90deg,var(--accent),#ff9d7f);width:0
  }
  .risk-dot{width:8px;height:8px;border-radius:50%}
  .risk-low{background:var(--good)}
  .risk-med{background:var(--warn)}
  .risk-high{background:var(--bad)}
  .explain{font-size:12px;text-decoration:underline;cursor:pointer}

  /* ---------- Sections ---------- */
  section{
    background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow);
  }
  section h3{margin:2px 0 10px;font-size:16px}
  .list{display:flex;flex-direction:column;gap:10px}

  /* Opportunity Map */
  .opp{display:grid;grid-template-columns: 28px 1fr auto;gap:10px;align-items:start;border:1px dashed var(--border);
       border-radius:12px;padding:10px 12px;background:linear-gradient(180deg,#fff, #fff6f4)}
  @media (prefers-color-scheme: dark){ .opp{background:linear-gradient(180deg,#111827,#131c31)}}
  .opp .rank{width:28px;height:28px;border-radius:50%;display:grid;place-items:center;background:#111827;color:#fff;font-weight:700;font-size:12px}
  .opp .meta{display:flex;gap:8px;flex-wrap:wrap;font-size:12px}
  .opp .score{font-weight:700}
  .btn{
    appearance:none;border:0;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer;
    background:var(--accent-2);color:#fff;box-shadow:0 8px 16px rgba(79,140,255,.25)
  }
  .btn.secondary{background:#edf2ff;color:#2543af;border:1px solid #cdd8ff}
  @media (prefers-color-scheme: dark){ .btn.secondary{background:#0f1a3a;color:#9db3ff;border-color:#1c2d63} }

  /* Strategy / table */
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
  .pill{font-size:11px;border-radius:999px;padding:4px 8px;border:1px solid var(--border);background:#f6f7fb}
  @media (prefers-color-scheme: dark){ .pill{background:#111827;border-color:#202b4b} }

  /* Alerts */
  .alert{
    display:grid;grid-template-columns: 28px 1fr auto;gap:10px;align-items:center;border-radius:12px;border:1px solid var(--border);padding:10px 12px;
  }
  .alert.high{background:#fff4f4}
  .alert.med{background:#fffaf0}
  .alert.low{background:#f2fff6}
  @media (prefers-color-scheme: dark){
    .alert.high{background:#2b1220}
    .alert.med{background:#2b2312}
    .alert.low{background:#10261a}
  }

  /* Timeline */
  .timeline{position:relative;padding-left:18px}
  .timeline::before{content:"";position:absolute;left:7px;top:0;bottom:0;width:2px;background:var(--border)}
  .tl-item{position:relative;margin:10px 0}
  .tl-item::before{content:"";position:absolute;left:-2px;top:6px;width:10px;height:10px;border-radius:50%;background:var(--accent)}

  /* Donut gauge */
  .donut{
    --pct: 78; /* set via style attr from JS as needed */
    width:110px;height:110px;border-radius:50%;
    background:
      conic-gradient(var(--accent) calc(var(--pct)*1%), #e6eaf6 0);
    display:grid;place-items:center;border:1px solid var(--border)
  }
  .donut::after{
    content: attr(data-label);
    width:82px;height:82px;border-radius:50%;display:grid;place-items:center;
    background:var(--card);box-shadow:inset 0 0 0 1px var(--border);
    font-weight:800
  }

  /* Drawer (Explain variance) */
  .drawer{
    position:fixed;right:16px;top:16px;bottom:16px;width:min(420px,90vw);background:var(--card);
    border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px;display:none;flex-direction:column;z-index:20
  }
  .drawer header{position:unset;background:transparent;border:0;padding:0;margin-bottom:8px}
  .drawer .close{margin-left:auto;cursor:pointer;border:0;background:transparent;font-size:20px}
  .drawer.show{display:flex}

  /* Footer */
  footer{padding:10px 18px;font-size:12px;color:var(--muted);text-align:right}

  /* Utility */
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .nowrap{white-space:nowrap}
  .right{justify-self:end}
  .hide{display:none}
</style>
</head>
<body>
<div class="container">
  <!-- Sidebar -->
  <aside class="sidebar" aria-label="Global navigation">
    <div class="brand" title="OEM">OEM</div>
    <button class="nav-btn active" title="Overview" aria-label="Overview">
      <!-- grid icon -->
      <svg width="22" height="22" viewBox="0 0 24 24" fill="#cfd8ff" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="7" height="7" rx="2"/><rect x="14" y="3" width="7" height="7" rx="2"/><rect x="3" y="14" width="7" height="7" rx="2"/><rect x="14" y="14" width="7" height="7" rx="2"/></svg>
    </button>
    <button class="nav-btn" id="categoriesBtn" title="Categories">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="#cfd8ff"><path d="M3 7h8l2 3H3zM3 14h18v3H3zM13 4h8v3h-6z"/></svg>
    </button>
    <button class="nav-btn" title="Playbooks">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="#cfd8ff"><path d="M5 4h12a2 2 0 0 1 2 2v12H7a2 2 0 0 0-2 2V4z"/><path d="M7 18h12v2H7a2 2 0 1 1 0-4h12v2H7z"/></svg>
    </button>
    <button class="nav-btn" title="Experiments">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="#cfd8ff"><path d="M7 3h10v2l-3 5v6l2 3H8l2-3V10L7 5z"/></svg>
    </button>
    <button class="nav-btn" title="Tasks">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="#cfd8ff"><path d="M4 6h12v2H4zM4 11h12v2H4zM4 16h8v2H4z"/><path d="M19 3 10 12l-2-2 9-9z"/></svg>
    </button>
    <button class="nav-btn" title="Reporting">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="#cfd8ff"><path d="M4 19h16v2H4zM6 10h3v7H6zM11 6h3v11h-3zM16 13h3v4h-3z"/></svg>
    </button>
    <button class="nav-btn" title="Admin">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="#cfd8ff"><path d="M12 8a4 4 0 1 1 0 8 4 4 0 0 1 0-8zm8.94 4.5a7.9 7.9 0 0 0-.07-1l2-1.55-2-3.46-2.41.49a8 8 0 0 0-1.73-1l-.36-2.45H9.63l-.36 2.45a8 8 0 0 0-1.73 1L5.13 3.5 3.13 7l2 1.55a8 8 0 0 0-.07 1l-2 1.45 2 3.5 2.41-.49c.53.38 1.12.7 1.73 1l.36 2.49h4.83l.36-2.49c.61-.3 1.2-.62 1.73-1l2.41.49 2-3.5-2-1.45z"/></svg>
    </button>
    <div class="spacer"></div>
    <div class="avatar">BD</div>
  </aside>

  <div>
    <!-- Topbar -->
    <header role="banner">
      <div class="topbar">
        <div class="search" role="search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="#9aa3b2"><path d="M10 3a7 7 0 1 1 0 14 7 7 0 0 1 0-14zm8.7 14.3 3.7 3.7-1.4 1.4-3.7-3.7z"/></svg>
          <input placeholder="Search dealers, VIN/RO, plays, tasksâ€¦" aria-label="Search"/>
          <span class="chip nowrap"><svg width="14" height="14" viewBox="0 0 24 24" fill="#8593b0"><path d="M3 7h18v2H3zM3 15h18v2H3z"/></svg> Saved View: <strong>&nbsp;My Region</strong></span>
        </div>
        <span class="chip nowrap">Dealer: <strong>&nbsp;All</strong></span>
        <span class="chip nowrap">Date: <strong>&nbsp;This week</strong></span>
        <span class="chip nowrap">Programme: <strong>&nbsp;All</strong></span>
        <span class="fresh" id="freshness"><span class="risk-low risk-dot"></span> Updated 10:32</span>
        <button class="btn secondary" id="exportBtn" title="Export pack">Export pack</button>
      </div>

      <!-- Categories mega menu (improved structure) -->
      <div id="mega" class="hide" style="border-top:1px solid var(--border);padding:12px 18px; background:var(--card)">
        <div class="grid-3">
          <div>
            <strong>Sales</strong>
            <ul>
              <li>New Vehicles</li>
              <li>Used Vehicles</li>
              <li>F&I</li>
              <li>Wholesale / Fleet</li>
              <li>Vehicle Acquisition &amp; Tradeâ€‘in</li>
            </ul>
          </div>
          <div>
            <strong>Aftersales</strong>
            <ul>
              <li>Service</li>
              <li>Parts</li>
              <li>Collision / Body Shop</li>
              <li>Accessories / Aftermarket</li>
              <li>Tyres</li>
              <li>Reconditioning</li>
            </ul>
          </div>
          <div>
            <strong>Crossâ€‘functional</strong>
            <ul>
              <li>Digital Leads &amp; Marketing</li>
              <li>Customer Experience / Retention</li>
              <li>Pricing &amp; Inventory</li>
              <li>Staffing &amp; Training</li>
              <li>OEM Programmes &amp; Incentives</li>
            </ul>
          </div>
        </div>
      </div>
    </header>

    <!-- Main content -->
    <main role="main">
      <!-- KPI Strip -->
      <section class="full">
        <div class="kpi-strip" id="kpiStrip" aria-label="Hero KPI cards (scrollable)"></div>
      </section>

      <!-- Opportunity Map -->
      <section>
        <h3>Opportunity Map</h3>
        <div id="oppList" class="list" aria-live="polite"></div>
      </section>

      <!-- Strategy Atâ€‘aâ€‘Glance -->
      <section>
        <h3>Strategy Atâ€‘aâ€‘Glance</h3>
        <table id="strategyTbl" aria-label="Active plays">
          <thead>
            <tr>
              <th>Play</th><th>Owner</th><th>Stage</th><th>Due</th><th>Forecast uplift</th><th>Conf.</th><th class="right">Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- Alerts & Risks -->
      <section class="full">
        <h3>Alerts &amp; Risks</h3>
        <div id="alerts" class="list"></div>
      </section>

      <!-- Recent Changes & Annotations -->
      <section class="full">
        <h3>Recent Changes &amp; Annotations</h3>
        <div class="timeline" id="timeline"></div>
      </section>

      <!-- Programme Status (donut) + Weekly Cadence -->
      <section>
        <h3>Programme Status</h3>
        <div class="grid-2" style="align-items:center">
          <div class="donut" id="programmeDonut" data-label="78%"></div>
          <div>
            <div><span class="pill">Bonus eligibility</span> <strong>At risk on D145</strong></div>
            <div class="muted" style="margin-top:8px">Gaps: training completion, claim docs, campaign alignment.</div>
            <div style="margin-top:10px; display:flex; gap:8px">
              <button class="btn">Start Programme Compliance Sprint</button>
              <button class="btn secondary">Open gap list</button>
            </div>
          </div>
        </div>
      </section>

      <section>
        <h3>Weekly Cadence â€“ This Week</h3>
        <ul class="list">
          <li class="pill">Top Risks x5</li>
          <li class="pill">Overdue tasks x3</li>
          <li class="pill">Experiments ending x2</li>
          <li class="pill">New opportunities x4</li>
          <li class="pill">Programme gaps x2</li>
        </ul>
      </section>
    </main>

    <footer>Last refreshed: 21 Aug 2025 â€¢ Source: CRM, DMS, OEM portals â€¢ Demo mockup, nonâ€‘production</footer>
  </div>
</div>

<!-- Variance Drawer -->
<aside class="drawer" id="drawer" aria-modal="true" role="dialog" aria-label="Explain variance">
  <header class="topbar" style="box-shadow:none;padding:0">
    <h3 style="margin:0">Explain variance</h3>
    <button class="close" aria-label="Close drawer">&times;</button>
  </header>
  <div id="drawerBody" style="overflow:auto">
    <!-- filled by JS -->
  </div>
</aside>

<script>
/* ======= Demo data ======= */
const kpis = [
  {
    id:"sales_vs_obj",
    title:"Sales vs Objective %",
    now:96, unit:"%", target:100, peer:+2, risk:"med",
    weekDelta:+3, monthDelta:+1,
    bar:96,
    spark:[86,88,90,93,91,95,96],
    explain:{
      summary:"Shortfall shrinking; primary driver was aged stock mix and demoâ€‘toâ€‘sale conversion.",
      root:[
        "Aged stock >90d at 14% (+4 WoW) concentrated in slow trims.",
        "Test Driveâ†’Sale conversion at 29% vs peer 34%.",
        "Priceâ€‘toâ€‘Market high on 60+ day units (101.8%)."
      ],
      actions:[
        "Apply 96â€“97% index to 60+ day units.",
        "Run 2â€‘day demo event; enforce booking discipline.",
        "Swap 3 slow trims with nearby dealer."
      ],
      benchmarks:[
        "Region median 94%; peer delta +2 pp.",
        "MoM trend +1 pp; tracking to target in ~2 weeks."
      ]
    }
  },
  {
    id:"service_ret",
    title:"Service Retention %",
    now:58, unit:"%", target:60, peer:-5, risk:"high",
    weekDelta:-1, monthDelta:-3,
    bar:58,
    spark:[66,64,63,61,60,59,58],
    explain:{
      summary:"Utilisation and booking lead time suppress repeat bookings.",
      root:[
        "Technician utilisation at 58% (target â‰¥75%).",
        "Booking lead time 9.2 days (target â‰¤5).",
        "Declined work recapture 23% vs peer 31%."
      ],
      actions:[
        "Open Express Lane Saturday 8â€“12.",
        "Rebalance rota; add 1 IMI L3 temp.",
        "Preâ€‘pick top 20 RO parts; upsell script refresh."
      ],
      benchmarks:["Peer median 63%; gap âˆ’5 pp."]
    }
  },
  {
    id:"csi",
    title:"CSI / NPS (0â€“100)",
    now:82, unit:"", target:85, peer:+1, risk:"med",
    weekDelta:0, monthDelta:+2,
    bar:82,
    spark:[84,83,82,82,81,82,82],
    explain:{
      summary:"Dip in delivery followâ€‘ups and service handover comms.",
      root:[
        "Delivery followâ€‘ups within 48h at 71% (target 90%).",
        "Service advisor comms driver weakening in verbatims."
      ],
      actions:["Enforce delivery checklist; schedule 48â€‘hour call.", "Advisor coaching; review scripts."]
    }
  },
  {
    id:"parts_fill",
    title:"Parts Fill Rate %",
    now:88, unit:"%", target:92, peer:-3, risk:"med",
    weekDelta:-2, monthDelta:-5,
    bar:88,
    spark:[94,93,92,91,90,89,88],
    explain:{
      summary:"A SKU min/max drift and specialâ€‘order ageing.",
      root:[
        "A SKUs min/max not refreshed in 180d.",
        "Special orders ageing >14d up 12%."
      ],
      actions:[
        "Refresh min/max on A SKUs.",
        "Tighten special order policy; weekly ageing purge."
      ]
    }
  },
  {
    id:"aged_stock",
    title:"Aged Stock >90d (Units / %)",
    now:"112 / 14%", unit:"", target:"â‰¤10%", peer:+2, risk:"high",
    weekDelta:"+9 units", monthDelta:"+4 units",
    bar:14,
    spark:[9,10,10,11,12,13,14],
    explain:{
      summary:"Recon photo delay and slow markdown cadence.",
      root:[
        "Photo/description delay 18h (target â‰¤4h).",
        "Markdown cadence missed 2 of last 3 weekends."
      ],
      actions:["48â€‘hour recon sprint.", "Enforce weekend markdowns; merchandising refresh."]
    }
  },
  {
    id:"programme",
    title:"Programme Adoption %",
    now:78, unit:"%", target:100, peer:-4, risk:"med",
    weekDelta:+2, monthDelta:+5,
    bar:78,
    spark:[69,71,72,73,75,76,78],
    explain:{
      summary:"Bonus eligibility risk on D145 documentation; training lag.",
      root:[
        "Training completion 82% (target 95%).",
        "Claim docs error rate 6.1% (target â‰¤2%)."
      ],
      actions:["Schedule training; documentation audit; align marketing to OEM push."]
    }
  }
];

const opportunities = [
  {cat:"Used",      driver:"Recon lead time +1.8 days", uplift:"+12â€“18 turns", time:"2â€“3 weeks", impact:8, confidence:0.7, effort:3, action:"Ageing Reduction Sprint"},
  {cat:"Service",   driver:"Utilisation 58% vs 75% target", uplift:"+6â€“9 hrs/day", time:"1â€“2 weeks", impact:7, confidence:0.75, effort:2, action:"Capacity Unlock â€“ Weekend Express"},
  {cat:"F&I",       driver:"VSC penetration 23% vs 31% peer", uplift:"+Â£80â€“Â£120 PVR", time:"4 weeks", impact:6, confidence:0.65, effort:2, action:"Lift VSC Penetration"},
  {cat:"Parts",     driver:"Fill rate 88% (âˆ’5 MoM)", uplift:"+3â€“5 pts", time:"3â€“4 weeks", impact:5, confidence:0.7, effort:2, action:"Raise Fill Rate"},
  {cat:"Marketing", driver:"Speedâ€‘toâ€‘lead 3.4 mins (target â‰¤1)", uplift:"+12â€“18% appt show", time:"2 weeks", impact:6, confidence:0.6, effort:1, action:"Lead Quality & Speed"}
];

const strategy = [
  {play:"48â€‘Hour Recon", owner:"Used Car Mgr", stage:"Executing", due:"Wed", uplift:"+1.6 days", conf:"0.7", status:"On track"},
  {play:"Menu 2.0 + Coaching", owner:"F&I Lead", stage:"Training", due:"Fri", uplift:"+Â£100 PVR", conf:"0.6", status:"At risk"},
  {play:"Weekend Express Lane", owner:"Service Mgr", stage:"Pilot", due:"Next Mon", uplift:"+8 hrs/day", conf:"0.65", status:"On track"},
  {play:"Aâ€‘SKU Min/Max Refresh", owner:"Parts Mgr", stage:"Planned", due:"In 10d", uplift:"+4 pts fill", conf:"0.75", status:"Blocked"}
];

const alerts = [
  {sev:"high",  text:"Used ageing >60 days increased to 24 units (+6 WoW). Recommended: apply 96â€“97% rule to slow movers."},
  {sev:"med",   text:"Service booking lead time 9.2 days (target â‰¤ 5). Recommended: open Saturday express lane; rebalance shift."},
  {sev:"med",   text:"Parts fill rate 88% (âˆ’5 pts MoM). Recommended: refresh min/max on A SKUs; purge >24m stock."},
  {sev:"low",   text:"CSI dip in new delivery followâ€‘ups. Recommended: enforce delivery checklist + 48â€‘hour call."}
];

const changes = [
  {when:"09:20", who:"BDM", what:"Added price rule: Slow trims to 97% index."},
  {when:"Yesterday", who:"Service Mgr", what:"Updated rota; added temp IMI L3 for 2 weeks."},
  {when:"2d ago", who:"Parts Mgr", what:"Raised matrix +3% on B SKUs."},
  {when:"4d ago", who:"F&I Lead", what:"Published Menu 2.0 script & checklist."}
];

/* ======= Render helpers ======= */
function el(html){const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstChild;}
function fmtDelta(n){
  if(typeof n==="string") return `<span class="delta">${n}</span>`;
  return n>=0 ? `<span class="delta up">+${n}${Math.abs(n)<=10?'':'%'}</span>` : `<span class="delta down">${n}${Math.abs(n)<=10?'':'%'}</span>`;
}
function riskDot(level){ return `<span class="risk-dot risk-${level}" title="Risk"></span>`; }
function sparklinePath(values, w=300, h=44, pad=4){
  const min = Math.min(...values), max = Math.max(...values);
  const dx = (w-2*pad) / (values.length-1);
  const scale = v => h - pad - ( (v-min)/(max-min||1) * (h-2*pad) );
  return values.map((v,i)=>`${i?'L':'M'} ${pad + i*dx} ${scale(v)}`).join(' ');
}
function setBar(elPct, pct){ elPct.style.width = Math.max(0, Math.min(100, pct)) + '%'; }

/* ======= Render KPI cards ======= */
const kpiStrip = document.getElementById('kpiStrip');
kpis.forEach(k=>{
  const card = el(`
    <article class="kpi" data-id="${k.id}">
      <div class="title">
        <h4>${k.title}</h4>
        <span class="badge">Target ${typeof k.target==='number' ? 'â‰¥ ' + k.target + (k.unit||'%') : k.target}</span>
      </div>
      <div class="value">
        <strong>${k.now}${k.unit||''}</strong>
        <span class="muted">vs peer ${k.peer>=0?'+':''}${k.peer}pp</span>
        ${riskDot(k.risk)}
      </div>
      <div class="spark">
        <svg width="100%" height="44" viewBox="0 0 300 44" preserveAspectRatio="none" aria-hidden="true">
          <path d="${sparklinePath(k.spark)}" fill="none" stroke="${getComputedStyle(document.documentElement).getPropertyValue('--accent')}" stroke-width="2" />
        </svg>
      </div>
      <div class="bar" title="Progress vs target">
        <i></i>
      </div>
      <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
        <div style="display:flex;gap:8px;align-items:center">
          <span class="muted">WoW ${fmtDelta(k.weekDelta)}</span>
          <span class="muted">MoM ${fmtDelta(k.monthDelta)}</span>
        </div>
        <button class="explain" data-id="${k.id}">Explain variance</button>
      </div>
    </article>
  `);
  kpiStrip.appendChild(card);
  const pctBar = card.querySelector('.bar > i');
  const pct = typeof k.bar === 'number' ? (k.unit==='%'||k.title.includes('%') ? k.bar : (parseFloat(k.bar)||0)) : 0;
  setBar(pctBar, Math.max(0, Math.min(100, pct)));
});

/* ======= Opportunity Map ======= */
const oppList = document.getElementById('oppList');
opportunities
  .map(o=>({...o, score: Math.round((o.impact*o.confidence)/(o.effort||1) * 10)/10}))
  .sort((a,b)=>b.score-a.score)
  .forEach((o,i)=>{
    const row = el(`
      <div class="opp">
        <div class="rank">${i+1}</div>
        <div>
          <div><strong>${o.cat}</strong> â€” ${o.driver}</div>
          <div class="meta">
            <span class="pill">Expected uplift ${o.uplift}</span>
            <span class="pill">Time to effect ${o.time}</span>
            <span class="pill">Impact ${o.impact}/10</span>
            <span class="pill">Confidence ${(o.confidence*100)|0}%</span>
            <span class="pill">Effort ${o.effort}</span>
            <span class="pill score" title="Impact Ã— Confidence Ã· Effort">Score ${o.score}</span>
          </div>
        </div>
        <div><button class="btn" data-play="${o.action}">Start a play</button></div>
      </div>
    `);
    oppList.appendChild(row);
  });

/* ======= Strategy table ======= */
const stBody = document.querySelector('#strategyTbl tbody');
strategy.forEach(s=>{
  const tr = el(`<tr>
    <td>${s.play}</td>
    <td>${s.owner}</td>
    <td><span class="pill">${s.stage}</span></td>
    <td>${s.due}</td>
    <td>${s.uplift}</td>
    <td>${Math.round(parseFloat(s.conf)*100)}%</td>
    <td class="right"><span class="pill">${s.status}</span></td>
  </tr>`);
  stBody.appendChild(tr);
});

/* ======= Alerts ======= */
const alertBox = document.getElementById('alerts');
alerts.forEach(a=>{
  const row = el(`<div class="alert ${a.sev}">
    <div class="risk-dot ${a.sev==='high'?'risk-high':a.sev==='med'?'risk-med':'risk-low'}"></div>
    <div>${a.text}</div>
    <div style="display:flex;gap:8px">
      <button class="btn secondary">Snooze 7d</button>
      <button class="btn">Assign</button>
    </div>
  </div>`);
  alertBox.appendChild(row);
});

/* ======= Timeline ======= */
const tl = document.getElementById('timeline');
changes.forEach(c=>{
  tl.appendChild(el(`<div class="tl-item"><div><strong>${c.when}</strong> â€” ${c.who}</div><div class="muted">${c.what}</div></div>`));
});

/* ======= Donut gauge bind ======= */
const prog = document.getElementById('programmeDonut');
prog.style.setProperty('--pct', 78);
prog.setAttribute('data-label','78%');

/* ======= Explain variance drawer ======= */
const drawer = document.getElementById('drawer');
const drawerBody = document.getElementById('drawerBody');

function openExplain(id){
  const k = kpis.find(x=>x.id===id);
  if(!k) return;
  drawerBody.innerHTML = `
    <div class="muted">KPI</div>
    <h3 style="margin:0">${k.title}</h3>
    <div style="display:flex;gap:12px;align-items:baseline;margin:8px 0">
      <strong style="font-size:26px">${k.now}${k.unit||''}</strong>
      <span class="pill">Target ${typeof k.target==='number'?'â‰¥ '+k.target+k.unit:k.target}</span>
      <span class="pill">vs peer ${k.peer>=0?'+':''}${k.peer} pp</span>
    </div>
    <p>${k.explain.summary||''}</p>
    ${k.explain.root? `<h4 style="margin:.5em 0 .2em">Drivers</h4><ul>${k.explain.root.map(x=>`<li>${x}</li>`).join('')}</ul>`:''}
    ${k.explain.actions? `<h4 style="margin:.8em 0 .2em">Recommended actions</h4><ol>${k.explain.actions.map(x=>`<li>${x}</li>`).join('')}</ol>`:''}
    ${k.explain.benchmarks? `<h4 style="margin:.8em 0 .2em">Benchmarks</h4><ul>${k.explain.benchmarks.map(x=>`<li>${x}</li>`).join('')}</ul>`:''}
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn">Create experiment</button>
      <button class="btn secondary">Assign task</button>
    </div>
  `;
  drawer.classList.add('show');
}
document.querySelectorAll('.explain').forEach(b=>{
  b.addEventListener('click', e=>openExplain(e.currentTarget.dataset.id));
});
document.querySelector('.drawer .close').addEventListener('click', ()=>drawer.classList.remove('show'));

/* ======= Header interactions ======= */
document.getElementById('categoriesBtn').addEventListener('click', ()=>{
  document.getElementById('mega').classList.toggle('hide');
});
document.getElementById('exportBtn').addEventListener('click', ()=>{
  alert('Mock export generated.');
});

/* Accessibility: close drawer with Esc */
document.addEventListener('keydown', e=>{
  if(e.key==='Escape') drawer.classList.remove('show');
});

/* Minor: colour bars initial width after styles load */
requestAnimationFrame(()=>{
  document.querySelectorAll('.kpi .bar > i').forEach(i=>{
    i.style.transition='width .8s cubic-bezier(.2,.8,.2,1)';
  });
});
</script>
</body>
</html>
